<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes"
    />
    <title>Unity WebGL Player | Cook Merge Bubbles</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
    <link rel="stylesheet" href="TemplateData/loadingStyle.css" />
  </head>
  <body>
    <div id="loadcontainer">
      <div id = "guideWrapper"class="guide-page-wrapper">
        <div class="guide-page-back"></div>
        <div class="guide-page">
          <h2 class="guide-page-title">
            HEY,<span class="guide-page-gold-text">CHEFS!</span>
          </h2>
          <div class="guide-page-text">
            Bubble cook is <b>web3</b> puzzle game, with a lot of abilities,
            levels and adventures
          </div>
          <img class="guide-page-img" src="TemplateData/Icon1.png" />
        </div>
        <div class="guide-page page-2">
          <h2 class="guide-page-title">
            EARN <span class="guide-page-green-text">TBIT</span> TOKENS
          </h2>
          <div class="guide-page-text">
            By passing the levels and upgrading the chef house you will earn
            TBIT tokens.Remember the <b>main rule</b> of levels - more moves
            left, more tokens you get
          </div>
          <img class="guide-page-img" src="TemplateData/icon2.png" />
        </div>
        <div class="guide-page page-3">
          <h2 class="guide-page-title">
            EXPAND CHEF <span class="guide-page-blue-text">COMMUNITY</span>
          </h2>
          <div class="guide-page-text">
            Invite friends, and <b>get bonuses </b>.By expanding the chef
            community, you will earn the currencies and special power-ups.
          </div>
          <img class="guide-page-img" src="TemplateData/icon3.Png" />
        </div>
        <div class="guide-page page-4">
          <h2 class="guide-page-title">
            BECOME THE <span class="guide-page-blue-text">BEST</span> CHEF!
          </h2>
          <div class="guide-page-text">
            Take part in daily activities and conquer <b> leaderboards</b> with
            your skill in puzzles. Good luck!
          </div>
          <img class="guide-page-img" src="TemplateData/Icon4.png" />
        </div>
        <div class="guide-page-buttons">
          <button class="guide-page-button">Next</button>
          <div class="guide-page-bottom-text">@bubble_cook_bot</div>
        </div>
      </div>
      <div id="loadcontainer-inner">
        <h1>Cooking the update..</h1>
        <div id="cooking" style="display: block">
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div id="area">
            <div id="sides">
              <div id="pan"></div>
              <div id="handle"></div>
            </div>
            <div id="pancake">
              <div id="pastry"></div>
            </div>
          </div>
        </div>
        <div id="unity-loading-bar">
          <div id="unity-logo"></div>
          <div id="unity-progress-bar-empty">
            <div id="unity-progress-bar-full"></div>
          </div>
        </div>
      </div>
      <div id="loadminigame" class="wrapper">
        <div><h2 class = "special">Try memory game</h2></div>
        <ul class="cards">
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-1.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-6.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-3.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-2.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-1.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-5.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-2.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-6.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-3.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-5.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
        </ul>
      </div>
    </div>

    <div id="mobileOnlyScreen">
      <img src="TemplateData/mobileOnly.jpeg" alt="Bubble Cook" />
    </div>

    <div id="unity-container">
      <canvas
        id="unity-canvas"
        width="1080"
        height="1920"
        style="width: 100%; height: 100%"
      ></canvas>
    </div>

    <script src="Build/bubblecookweb.loader.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="payment.js" defer></script>

    <script>
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var mobileOnlyScreen = document.querySelector("#mobileOnlyScreen");


      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/bubblecookweb.loader.js";
      var config = {
        dataUrl: buildUrl + "/bubblecookweb.data.gz",
        frameworkUrl: buildUrl + "/bubblecookweb.framework.js.gz",
        codeUrl: buildUrl + "/bubblecookweb.wasm.gz",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Cook Merge Bubbles",
        productVersion: "1.0.3",
        showBanner: false,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement("meta");
        meta.name = "viewport";
        meta.content =
          "width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes";
        document.getElementsByTagName("head")[0].appendChild(meta);

        var canvas = document.querySelector("#unity-canvas");
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";

        document.body.style.textAlign = "left";
      }

      loadingBar.style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        var platform = window.Telegram.WebApp.platform.toLowerCase();
        if (platform != "ios" && platform != "android") {
          mobileOnlyScreen.style.display = "flex";
          return;
        }
        const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
        if (telegramUser) {
          const telegramId = telegramUser.id;
          const referralCode =
            window.Telegram.WebApp.initDataUnsafe.start_param;
          const username = telegramUser.username || "unknown";
          console.log("Updated" + referralCode);
          fetch(
            "https://gracious-friendship-production.up.railway.app/api/users",
            {
              method: "POST",
              headers: {
                accept: "*/*",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                telegramId: telegramId,
                username: username,
                referralCode: referralCode,
              }),
            }
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
            })
            .then((data) => {
              console.log("User registered:", data);
            })
            .catch((error) => {
              console.error(
                "There was a problem with the fetch operation:",
                error
              );
            });
        }

        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        })
          .then((unityInstance) => {
            window.UNITY_INSTANCE = unityInstance;
            container.style.display = "block";

            document.querySelector("h1").textContent = "Finishing bubbles...";
          })
          .catch((message) => {
            alert(message);
          });
      };
      document.body.appendChild(script);

      //minigame

      const cards = document.querySelectorAll(".card");
      console.log(cards, "cards");
      let matched = 0;
      let cardOne, cardTwo;
      let disableDeck = false;

      function flipCard({ target: clickedCard }) {
        if (cardOne !== clickedCard && !disableDeck) {
          clickedCard.classList.add("flip");
          if (!cardOne) {
            return (cardOne = clickedCard);
          }
          cardTwo = clickedCard;
          disableDeck = true;
          let cardOneImg = cardOne.querySelector(".back-view img").src,
            cardTwoImg = cardTwo.querySelector(".back-view img").src;
          matchCards(cardOneImg, cardTwoImg);
        }
      }

      function matchCards(img1, img2) {
        if (img1 === img2) {
          matched++;
          if (matched == 8) {
            setTimeout(() => {
              return shuffleCard();
            }, 1000);
          }
          cardOne.removeEventListener("click", flipCard);
          cardTwo.removeEventListener("click", flipCard);
          cardOne = cardTwo = "";
          return (disableDeck = false);
        }
        setTimeout(() => {
          cardOne.classList.add("shake");
          cardTwo.classList.add("shake");
        }, 400);

        setTimeout(() => {
          cardOne.classList.remove("shake", "flip");
          cardTwo.classList.remove("shake", "flip");
          cardOne = cardTwo = "";
          disableDeck = false;
        }, 1200);
      }

      function shuffleCard() {
        matched = 0;
        disableDeck = false;
        cardOne = cardTwo = "";
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8];
        arr.sort(() => (Math.random() > 0.5 ? 1 : -1));
        cards.forEach((card, i) => {
          card.classList.remove("flip");
          let imgTag = card.querySelector(".back-view img");
          imgTag.src = `TemplateData/images/img-${arr[i]}.png`;
          card.addEventListener("click", flipCard);
        });
      }

      shuffleCard();

      cards.forEach((card) => {
        card.addEventListener("click", flipCard);
      });

      // guide logic
      const guidePageEl = document.querySelector(".guide-page-wrapper");
      let page = 1;
      const button = document.querySelector(".guide-page-button");
      const buttonsWrapper = document.querySelector(".guide-page-buttons");
      const guideBack = document.querySelector(".guide-page-back");

      button.addEventListener("click", () => {
        if (page === 1) {
          guidePageEl.style.left = "-100%";
        }
        if (page === 2) {
          guidePageEl.style.left = "-200%";
        }
        if (page === 3) {
          guidePageEl.style.left = "-300%";
        }
        if (page === 4) {
          guidePageEl.style.left = "-400%";
          buttonsWrapper.style.left = "-100vw";
          guideBack.style.left = "-100vw";
          setTimeout(() => {
            const firstCard = document.querySelector('.card')
            firstCard.classList.add("flip");
            setTimeout(() => {
              firstCard.classList.remove("flip");
            }, 1500)
          }, 1100)
        }

        page = page + 1;
      });
    </script>
  </body>
</html>
