<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes"
    />
    <title>Unity WebGL Player | Cook Merge Bubbles</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
    <link rel="stylesheet" href="TemplateData/loadingStyle.css" />
  </head>
  <body>
    <div id="loadcontainer">
      <div id = "guideWrapper"class="guide-page-wrapper">
        <div class="guide-page-back"></div>
        <div class="guide-page">
          <h2 class="guide-page-title" data-lang-en = "HEY,&lt;span class=&quot;guide-page-gold-text&quot;&gt;CHEFS!&lt;/span&gt;" 
                                       data-lang-ru = "ПРИВЕТ,&lt;span class=&quot;guide-page-gold-text&quot;&gt;ШЕФЫ!&lt;/span&gt;">
          </h2>
          <div class="guide-page-text" data-lang-en="Bubble cook is &lt;b&gt;web3&lt;/b&gt; puzzle game, with a lot of abilities, levels and adventures. Make yourself comfortable in your seats,
                                                     prepare some popcorn and join our friendly community."
                                       data-lang-ru="Bubble cook — это &lt;b&gt;web3&lt;/b&gt; головоломка с множеством возможностей, уровней и приключений. Устраивайтесь поудобнее, приготовьте попкорн и присоединяйтесь к нашему дружному сообществу.">
          
          </div>
          <img class="guide-page-img" src="TemplateData/Icon1.png" />
        </div>
        <div class="guide-page page-2">
          <h2 class="guide-page-title" data-lang-en = "EARN &lt;span class=&quot;guide-page-green-text&quot;&gt;$TBIT&lt;/span&gt; TOKENS"
                                       data-lang-ru = "ЗАРАБАТЫВАЙ &lt;span class=&quot;guide-page-green-text&quot;&gt;$TBIT&lt;/span&gt; ТОКЕНЫ">                                      
          </h2>
          <div class="guide-page-text" data-lang-en="By passing the levels and upgrading the chef house you will earn TBIT tokens. Remember the &lt;b&gt;main rule&lt;/b&gt; of levels - more moves left, more tokens you get."
                                       data-lang-ru="Проходя уровни и улучшая дом шефа, вы будете зарабатывать токены TBIT. Помните &lt;b&gt;главное правило&lt;/b&gt; уровней: чем больше ходов останется, тем больше токенов вы получите.">

          </div>
          <img class="guide-page-img" src="TemplateData/icon2.png" />
        </div>
        <div class="guide-page page-3">
          <h2 class="guide-page-title" data-lang-en = "EXPAND CHEF &lt;span class=&quot;guide-page-blue-text&quot;&gt;COMMUNITY!&lt;/span&gt;" 
                                       data-lang-ru = "РАСШИРЯЙ &lt;span class=&quot;guide-page-blue-text&quot;&gt;СООБЩЕСТВО&lt;/span&gt; ШЕФОВ!">                                     
          </h2>
          <div class="guide-page-text" data-lang-en="Invite friends, and &lt;b&gt;get bonuses&lt;/b&gt;. By expanding the chef community, you will earn the currencies and special power-ups"
                                       data-lang-ru="Приглашайте друзей и &lt;b&gt;получайте бонусы&lt;/b&gt;. Расширяя с нами сообщество шефов, вы будете зарабатывать валюту и специальные усиления">

          </div>
          <img class="guide-page-img" src="TemplateData/icon3.Png" />
        </div>
        <div class="guide-page page-4">
          <h2 class="guide-page-title" data-lang-en = "BECOME THE &lt;span class=&quot;guide-page-blue-text&quot;&gt;BEST&lt;/span&gt; CHEF!"
                                       data-lang-ru = "СТАНЬ &lt;span class=&quot;guide-page-blue-text&quot;&gt;ЛУЧШИМ&lt;/span&gt; ШЕФОМ!">
            BECOME THE <span class="guide-page-blue-text">BEST</span> CHEF!
          </h2>
          <div class="guide-page-text" data-lang-en="Take part in daily activities and conquer &lt;b&gt;leaderboards&lt;/b&gt; with your skill in puzzles. Good luck!"
                                       data-lang-ru="Участвуйте в ежедневных активностях и покоряйте &lt;b&gt;турнирные таблицы&lt;/b&gt; благодаря своим навыкам в головоломках. Удачи!">
          </div>
          <img class="guide-page-img" src="TemplateData/Icon4.png" />
        </div>
        <div class="guide-page-buttons">
          <button class="guide-page-button" data-lang-en ="Next" data-lang-ru ="Далее"></button>
          <div class="guide-page-bottom-text">@bubble_cook_bot</div>
        </div>
      </div>
      <div id="loadcontainer-inner">
        <h1 data-lang-en="Cooking the update.." data-lang-ru="Жарим обновление">Cooking the update..</h1>
        <div id="cooking" style="display: block">
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div id="area">
            <div id="sides">
              <div id="pan"></div>
              <div id="handle"></div>
            </div>
            <div id="pancake">
              <div id="pastry"></div>
            </div>
          </div>
        </div>
        <div id="unity-loading-bar">
          <div id="unity-logo"></div>
          <div id="unity-progress-bar-empty">
            <div id="unity-progress-bar-full"></div>
          </div>
        </div>
      </div>
      <div id="loadminigame" class="wrapper" >
        <div><h2 class = "special" data-lang-en="Try memory game" data-lang-ru="Найди пары!">Try memory game</h2></div>
        <ul class="cards">
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-1.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-6.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-3.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-2.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-1.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-5.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-2.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-6.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-3.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-5.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
          <li class="card">
            <div class="view front-view">
              <img src="TemplateData/images/que_icon.svg" alt="icon" />
            </div>
            <div class="view back-view">
              <img src="images/img-4.png" alt="card-img" />
            </div>
          </li>
        </ul>
      </div>
    </div>

    <div id="mobileOnlyScreen">
      <img src="TemplateData/mobileOnly.jpeg" alt="Bubble Cook" />
    </div>

    <div id="unity-container">
      <canvas
        id="unity-canvas"
        width="1080"
        height="1920"
        style="width: 100%; height: 100%"
      ></canvas>
    </div>

    <script src="Build/bubblecookweb.loader.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="payment.js" defer></script>

    <script>
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var mobileOnlyScreen = document.querySelector("#mobileOnlyScreen");
      var guidePage = document.getElementById("guideWrapper")

      window.Telegram.WebApp.disableVerticalSwipes();


      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/bubblecookweb.loader.js";
      var config = {
        dataUrl: buildUrl + "/bubblecookweb.data.gz",
        frameworkUrl: buildUrl + "/bubblecookweb.framework.js.gz",
        codeUrl: buildUrl + "/bubblecookweb.wasm.gz",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Cook Merge Bubbles",
        productVersion: "1.0.3",
        showBanner: false,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement("meta");
        meta.name = "viewport";
        meta.content =
          "width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes";
        document.getElementsByTagName("head")[0].appendChild(meta);

        var canvas = document.querySelector("#unity-canvas");
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";

        document.body.style.textAlign = "left";
      }

      loadingBar.style.display = "block";

      function decodeHTML(html) {
       const textArea = document.createElement('textarea');
       textArea.innerHTML = html;
       return textArea.value;
      }

      function switchLanguage(lang) {
          document.querySelectorAll('[data-lang-en]').forEach(element => {
          const encodedHTML = element.getAttribute(`data-lang-${lang}`);
          element.innerHTML = decodeHTML(encodedHTML);
      });
      }

      switchLanguage('en');

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        var platform = window.Telegram.WebApp.platform.toLowerCase();
        if (platform != "ios" && platform != "android") {
          //mobileOnlyScreen.style.display = "flex";
          //return;
        }
        const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
        if (telegramUser) {
          const telegramId = telegramUser.id;
          const referralCode =
            window.Telegram.WebApp.initDataUnsafe.start_param;
          const username = telegramUser.username || "unknown";
          const languageCode = telegramUser.language_code;

          console.log(languageCode);
          if(languageCode == "ru"){
            switchLanguage('ru');
          }
          console.log("Updated" + referralCode);
          fetch(
            "https://gracious-friendship-production.up.railway.app/api/users",
            {
              method: "POST",
              headers: {
                accept: "*/*",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                telegramId: telegramId,
                username: username,
                referralCode: referralCode,
              }),
            }
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              if(response.status === 200){
                console.log(response.status);
                guidePage.style.display = "flex"
              }
            })
            .then((data) => {
              console.log("User registered:", data);
            })
            .catch((error) => {
              console.error(
                "There was a problem with the fetch operation:",
                error
              );
            });
        }

        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        })
          .then((unityInstance) => {
            window.UNITY_INSTANCE = unityInstance;
            container.style.display = "block";
            document.querySelector("#cooking").style.display = "none"
            if(window.Telegram.WebApp.initDataUnsafe.user.language_code == "ru"){
              document.querySelector("h1").textContent = "Заканчиваем готовку";
            }
            else{
              document.querySelector("h1").textContent = "Finishing bubbles...";
            }
            
          })
          .catch((message) => {
            alert(message);
          });
      };
      document.body.appendChild(script);

      //minigame

      const cards = document.querySelectorAll(".card");
      console.log(cards, "cards");
      let matched = 0;
      let cardOne, cardTwo;
      let disableDeck = false;

      function flipCard({ target: clickedCard }) {
        if (cardOne !== clickedCard && !disableDeck) {
          clickedCard.classList.add("flip");
          if (!cardOne) {
            return (cardOne = clickedCard);
          }
          cardTwo = clickedCard;
          disableDeck = true;
          let cardOneImg = cardOne.querySelector(".back-view img").src,
            cardTwoImg = cardTwo.querySelector(".back-view img").src;
          matchCards(cardOneImg, cardTwoImg);
        }
      }

      function matchCards(img1, img2) {
        if (img1 === img2) {
          matched++;
          if (matched == 8) {
            setTimeout(() => {
              return shuffleCard();
            }, 1000);
          }
          cardOne.removeEventListener("click", flipCard);
          cardTwo.removeEventListener("click", flipCard);
          cardOne = cardTwo = "";
          return (disableDeck = false);
        }
        setTimeout(() => {
          cardOne.classList.add("shake");
          cardTwo.classList.add("shake");
        }, 400);

        setTimeout(() => {
          cardOne.classList.remove("shake", "flip");
          cardTwo.classList.remove("shake", "flip");
          cardOne = cardTwo = "";
          disableDeck = false;
        }, 1200);
      }

      function shuffleCard() {
        matched = 0;
        disableDeck = false;
        cardOne = cardTwo = "";
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8];
        arr.sort(() => (Math.random() > 0.5 ? 1 : -1));
        cards.forEach((card, i) => {
          card.classList.remove("flip");
          let imgTag = card.querySelector(".back-view img");
          imgTag.src = `TemplateData/images/img-${arr[i]}.png`;
          card.addEventListener("click", flipCard);
        });
      }

      shuffleCard();

      cards.forEach((card) => {
        card.addEventListener("click", flipCard);
      });

      // guide logic
      const guidePageEl = document.querySelector(".guide-page-wrapper");
      let page = 1;
      const button = document.querySelector(".guide-page-button");
      const buttonsWrapper = document.querySelector(".guide-page-buttons");
      const guideBack = document.querySelector(".guide-page-back");

      button.addEventListener("click", () => {
        if (page === 1) {
          guidePageEl.style.left = "-100%";
        }
        if (page === 2) {
          guidePageEl.style.left = "-200%";
        }
        if (page === 3) {
          guidePageEl.style.left = "-300%";
        }
        if (page === 4) {
          guidePageEl.style.left = "-400%";
          buttonsWrapper.style.left = "-100vw";
          guideBack.style.left = "-100vw";
          setTimeout(() => {
            const firstCard = document.querySelector('.card')
            firstCard.classList.add("flip");
            setTimeout(() => {
              firstCard.classList.remove("flip");
            }, 1500)
          }, 1100)
        }

        page = page + 1;
      });
    </script>
  </body>
</html>
